![Update Supervisor UI](docs/images/update-supervisor.png)

# Update Supervisor â€“ Aktualizr D-Bus UI (Proof of Concept)

This project is a **proof of concept (PoC)** demonstrating how to build a graphical
user interface that interacts with **Aktualizr** via its **D-Bus API** to:

- Check for OTA updates
- Require or bypass user consent
- Approve or refuse updates
- Monitor update progress and lifecycle events
- Trigger system reboot when required

The UI is implemented using **PySide6 (Qt for Python)** and communicates with
Aktualizr exclusively through its supported D-Bus interface.

This project is **not production-ready** and intentionally prioritizes clarity,
deterministic behavior, and debuggability over completeness.

## Requirements

- **Torizon OS 7.4 or newer** (minimum required)
- Device configured for Aktualizr / Torizon Cloud OTA

### Development workflow (Torizon VS Code Extension)

This repository is structured so it can be imported as a project using the
**Torizon VS Code Extension**.

Typical workflow:
- Import/open the project in VS Code using the Torizon extension
- Build and run the application using the extension's tasks
- Deploy to a target device running Torizon OS

## Scope and Design Goals

- Demonstrate correct usage of the Aktualizr D-Bus API
- Visualize update phases and progress in a human-readable way
- Remain independent from internal Aktualizr implementation details
- Be easy to adapt to native Linux systems (non-containerized)

## Architecture Overview

The PoC consists of three main components:

### 1) UI Application (PySide6)

- Connects to Aktualizr via D-Bus
- Displays update state, consent requests, and progress
- Allows the user to:
  - Toggle automatic vs consent-required updates
  - Trigger an immediate update check
  - Accept or refuse updates
  - Reboot the system when required

### 2) D-Bus Worker Thread

- Runs in a background thread with its own asyncio loop
- Uses the official Aktualizr D-Bus API
- Emits Qt signals to keep the UI responsive and decoupled
- Parses update lifecycle events and progress

### 3) Log Forwarding (Optional)

- Update progress and phase events can be derived from logs
- In this PoC, logs are optionally forwarded into a plain text file
- Native systems may consume logs directly from `journalctl`

## Log Forwarding Strategy (Important)

The UI may derive update progress and lifecycle events from Aktualizr logs.

### Container-based setup (PoC reference)

In the container-based proof of concept, logs are forwarded from `journald`
into a plain text file:

```
/home/torizon/ota-progress/aktualizr.log
```

This file is generated by a small forwarder script that tails:

```bash
journalctl -u aktualizr-torizon -f
```

The UI then tails this file to extract progress percentages and phase events.

This approach was chosen to:
- simplify log access from inside containers
- avoid direct dependencies on journald bindings
- keep the PoC easy to inspect and debug

The log file is treated as a **session buffer** and is truncated on startup
to avoid replaying stale events from previous runs.

### Native Linux systems (no container)

On native Linux systems, it is **not required** to forward logs into a file.

An implementation may instead:
- consume logs directly from `journalctl -u aktualizr-torizon`, or

The file-based log forwarding approach is used in this PoC purely as a
convenience mechanism and is **not a requirement** of the Aktualizr D-Bus API.

Integrators are free to replace or remove the log parsing layer entirely
in native deployments.

## systemd Service (Optional)

When using the file-based log forwarding approach on a native Linux system,
the forwarder is expected to run as a `systemd` service.

A sample unit file is provided:

```
forward-aktualizr-logs.service
```

This service:
- starts the log forwarder automatically on boot
- truncates the log file at startup to ensure session-based behavior
- ensures the UI does not replay stale update events

If logs are consumed directly from `journalctl`, this service can be omitted.

## Network Interface for Throughput Estimation

The UI optionally displays a rough network throughput indicator during
download phases.

By default, RX/TX counters are read from:

```
/sys/class/net/ethernet0/statistics/
```

The interface name can be overridden using the environment variable:

```bash
OTA_NET_IFACE=eth0
```

This metric is **purely informational** and does not affect update behavior.
If the interface is unavailable, network monitoring is silently disabled.

## Aktualizr D-Bus API Usage

This PoC uses **only the officially supported D-Bus API** provided by Aktualizr.

Reference documentation:
- https://gitlab.com/toradex/rd/torizon-core/aktualizr/-/blob/toradex-master/docs/markdown/dbus-api.md

### Configuration API

Property:

```
InstallUpdatesAutomatically (int)
```

Values:

| Value | Meaning                       |
|------:|-------------------------------|
| 0     | Updates proceed automatically |
| 1     | Updates require user consent  |

Example:

```bash
busctl set-property org.uptane.Aktualizr \
  /org/uptane/aktualizr \
  org.uptane.Aktualizr \
  InstallUpdatesAutomatically i 1
```

### Consent API

Aktualizr exposes a read-only property:

```
ConsentRequired
```

When non-empty, it contains Uptane Targets in JSON format.

Example:

```bash
busctl get-property org.uptane.Aktualizr \
  /org/uptane/aktualizr \
  org.uptane.Aktualizr \
  ConsentRequired
```

User response is sent via:

```bash
busctl call org.uptane.Aktualizr \
  /org/uptane/aktualizr \
  org.uptane.Aktualizr \
  Consent bs true "Accepted via UI"
```

### Check For Updates

```bash
busctl call org.uptane.Aktualizr \
  /org/uptane/aktualizr \
  org.uptane.Aktualizr \
  CheckForUpdates
```

### Cancel Update

```bash
busctl call org.uptane.Aktualizr \
  /org/uptane/aktualizr \
  org.uptane.Aktualizr \
  Cancel
```

## Container vs Native System

This PoC was initially developed in a containerized environment.

On a **native Linux system**, the following changes are typically required:

- Direct access to the system D-Bus
- systemd-based service management
- Native polkit rules for reboot authorization
- Adjusted log paths and permissions

The UI logic and D-Bus interaction remain unchanged.

## Disclaimer

This repository is a **proof of concept**.

- Not intended for production use
- No hardening, security review, or long-term persistence guarantees
- Designed to demonstrate behavior, flow, and API usage only
